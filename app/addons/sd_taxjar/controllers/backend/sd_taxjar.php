<?php
 use Tygh\Registry; use Tygh\Settings; use Tygh\Debugger; defined('BOOTSTRAP') or die('Access denied'); if ($_SERVER['REQUEST_METHOD'] == 'POST') { if ($mode == 'update_product_tax_code') { $client = fn_sd_taxjar_client_init(); if (!empty($client)) { $codes = fn_sd_taxjar_get_products_tax_codes($client); if (!empty($codes)) { fn_sd_taxjar_update_products_tax_codes($codes); } } } elseif ($mode == 'export') { $params = $_REQUEST; if (!empty($params['company_id']) && Registry::get('runtime.company_id') && Registry::get('runtime.company_id') != $params['company_id'] ) { fn_company_access_denied_notification(); } elseif (!empty($params['company_id']) && !empty($params['company_data'])) { fn_update_company($params['company_data'], $params['company_id'], DESCR_SL); $dir = fn_sd_taxjar_order_get_export_dir($params['company_id']); fn_rm($dir, false); $url = array( 'page' => 1, 'company_id' => $params['company_id'], 'return_url' => !empty($params['r_url']) ? $params['r_url'] : 'companies.manage', ); fn_redirect(fn_url('sd_taxjar.export?' . http_build_query($url))); } } return array(CONTROLLER_STATUS_OK); } if ($mode == 'get_taxes') { if (defined('AJAX_REQUEST')) { $auth = Tygh::$app['session']['auth']; $product_id = !empty($_REQUEST['product_id']) ? $_REQUEST['product_id'] : 0; $product_data = fn_get_product_data($product_id, $auth); $company_id = !empty($_REQUEST['company_id']) ? $_REQUEST['company_id'] : 1; $shipping = (!empty($_REQUEST['shipping'])) ? $_REQUEST['shipping'] : 0; $tax_product = fn_sd_taxjar_tax_for_order(array( 'auth' => $_REQUEST, 'product' => $product_data, 'shipping' => $shipping )); $product_rate = $shipping_rate = 0; if (!empty($tax_product['breakdown']['shipping'])) { $shipping_rate = !empty($tax_product['breakdown']['shipping']['tax_subtotal']) ? $tax_product['breakdown']['shipping']['tax_subtotal'] : 0; $product_rate = $tax_product['tax_subtotal'] - $shipping_rate; } $customer_data = fn_sd_taxjar_get_full_convert_data($_REQUEST); fn_sd_taxjar_unset_data($customer_data, array('rule' => '/from_/')); if (fn_allowed_for('ULTIMATE')) { $settings = Settings::instance($company_id)->getValues(); $company_data = $settings['Company']; } else { $company_data = fn_get_company_data($company_id); } $vendor_data = fn_sd_taxjar_get_full_convert_data($company_data); fn_sd_taxjar_unset_data($vendor_data, array('rule' => '/to_/')); if (empty($customer_data['to_state']) || empty($customer_data['to_country']) || empty($customer_data['to_zip']) || empty($vendor_data['from_state']) || empty($vendor_data['from_country']) || empty($vendor_data['from_zip']) ) { fn_set_notification('E', __('error'), __('addons.sd_taxjar.no_auth_user')); } Tygh::$app['view']->assign('taxjar_taxes', array( 'vendor' => $vendor_data, 'customer' => $customer_data, 'price' => $product_data['price'], 'shipping' => $shipping, 'tax_product' => $product_rate, 'tax_shipping' => $shipping_rate, 'total' => $product_data['price'] + $shipping, 'tax_total' => $tax_product['tax_subtotal'], 'show_get_taxjar_taxes' => true )); Tygh::$app['view']->display('addons/sd_taxjar/hooks/products/detailed_content.post.tpl'); exit; } } elseif ($mode == 'export') { @set_time_limit(0); $params = $_REQUEST; $return_url = !empty($params['return_url']) ? urldecode($params['return_url']) : 'companies.manage'; if (empty($params['company_id'])) { return array(CONTROLLER_STATUS_OK, $return_url); } if (Debugger::isActive() || fn_is_development()) { Registry::set('runtime.comet', true); } $export_settings = fn_get_company_data($params['company_id']); $page = !empty($params['page']) ? $params['page'] : 1; $dir = fn_sd_taxjar_order_get_export_dir($params['company_id']); if (empty($export_settings['taxjar_export_csv_data']['export_csv_statuses'])) { fn_set_notification('W', __('error'), __('addons.sd_taxjar.no_statuses_selected')); return array(CONTROLLER_STATUS_OK, $return_url); } $order_params = array( 'page' => $page, 'items_per_page' => !empty($params['items_per_page']) ? $params['items_per_page'] : $export_settings['taxjar_export_csv_data']['items_per_file'], 'taxjar_export' => true, 'status' => $export_settings['taxjar_export_csv_data']['export_csv_statuses'], 'time_from' => !empty($export_settings['taxjar_export_csv_data']['time_from']) ? $export_settings['taxjar_export_csv_data']['time_from'] : 0, 'time_to' => !empty($export_settings['taxjar_export_csv_data']['time_to']) ? $export_settings['taxjar_export_csv_data']['time_to'] : TIME, 'period' => 'C', 'company_id' => $params['company_id'], ); list($orders, $search) = fn_get_orders($order_params, $order_params['items_per_page'], false); if (!empty($orders)) { $search['sd_count_objects'] = count($orders); foreach ($orders as $key => $order) { $data = fn_sd_taxjar_order_export_prepare_data($order); if (!empty($data)) { $csv_data[] = $data; } } } else { fn_set_notification('W', __('error'), __('text_no_orders')); return array(CONTROLLER_STATUS_OK, $return_url); } if (!empty($csv_data)) { $options = array( 'lang_code' => array(CART_LANGUAGE), 'filename' => 'taxjar_import_part_' . $page . '.csv', 'delimiter' => 'C', 'dir' => $dir, 'force_header' => true ); $result_csv = fn_sd_taxjar_order_export_generate_csv($csv_data, $options, '"'); } $counter = (($page - 1) * $order_params['items_per_page'] + $search['sd_count_objects']) . '/' . $search['total_items'] . PHP_EOL; fn_echo(__('addons.sd_taxjar.export_orders_counter', array('[counter]' => $counter))); $page++; if ($search['total_items'] > $search['page'] * $search['items_per_page']) { $url = array( 'page' => $page, 'items_per_page' => $order_params['items_per_page'], 'return_url' => $return_url, ); fn_redirect(fn_url('sd_taxjar.export?' . http_build_query($url))); } else { $file = 'orders_export_' . date('dMY_His', TIME) . '.zip'; $res = fn_sd_taxjar_order_export_pack_results($file, $params['company_id']); fn_echo('<br>' . __('done')); if ($res) { $url = 'sd_taxjar.get_file?filename=' . rawurlencode($file) . '&company_id=' . $params['company_id']; fn_echo('<br>' . __('addons.sd_taxjar.download_archive', array( '[url]' => fn_url($url) ))); fn_echo('<br>' . __('addons.sd_taxjar.return', array('[return]' => fn_url($return_url)))); $return_url = 'sd_taxjar.get_file?filename=' . rawurlencode($file) . '&company_id=' . $params['company_id']; } } return array(CONTROLLER_STATUS_OK, $return_url); } elseif ($mode == 'get_file' && !empty($_REQUEST['filename']) && !empty($_REQUEST['company_id'])) { $file = fn_basename($_REQUEST['filename']); $dir = fn_sd_taxjar_order_get_export_dir($_REQUEST['company_id']); if (!empty($_REQUEST['to_screen'])) { header("Content-type: text/plain"); readfile($dir . '/' . $file); exit; } else { fn_get_file($dir . '/' . $file); } } 