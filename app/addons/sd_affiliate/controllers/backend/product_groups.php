<?php
 use Tygh\Registry; use Tygh\Enum\BannerLinkTypes; defined('BOOTSTRAP') or die('Access denied'); if ($_SERVER['REQUEST_METHOD'] == 'POST') { fn_trusted_vars('group', 'groups_data'); $suffix = ''; if ($mode == 'm_delete') { if (!empty($_REQUEST['group_ids'])) { fn_delete_affiliate_groups($_REQUEST['group_ids']); } $suffix = '.manage'; if (!empty($_REQUEST['link_to'])) { $suffix .= '?link_to=' . $_REQUEST['link_to']; } } if ($mode == 'update') { if (empty($_REQUEST['group']['data'])) { fn_set_notification('W', __('warning'), __('addons.sd_affiliate.product_group_empty_data')); } $group_id = fn_update_affiliate_group($_REQUEST['group'], $_REQUEST['group_id'], DESCR_SL); $suffix = ".update?group_id=$group_id&link_to=" . $_REQUEST['group']['link_to']; if ($group_id === false) { fn_set_notification('E', __('error'), __('aff_cant_create_group')); return [CONTROLLER_STATUS_REDIRECT, 'product_groups.manage']; } if (!empty($_REQUEST['return_to_list']) && !empty($_REQUEST['group']['link_to'])) { $_REQUEST['redirect_url'] = 'product_groups.manage?link_to=' . $_REQUEST['group']['link_to']; } } return [CONTROLLER_STATUS_OK, "product_groups{$suffix}"]; } if ($mode == 'update') { $group = fn_get_group_data($_REQUEST['group_id'], DESCR_SL); if (fn_allowed_for('ULTIMATE')) { $company_id = fn_get_runtime_company_id(); if ($company_id) { if ($group['company_id'] != $company_id) { unset($group); } } } if (empty($group)) { return [CONTROLLER_STATUS_NO_PAGE]; } Tygh::$app['view']->assign('group', $group); } elseif ($mode == 'add') { $link_to = empty($_REQUEST['link_to']) ? 'C' : $_REQUEST['link_to']; Tygh::$app['view']->assign('link_to', $link_to); } elseif ($mode == 'manage') { Registry::set('navigation.tabs', [ BannerLinkTypes::CATEGORIES => [ 'title' => __('group_for_category'), 'href' => 'product_groups.manage?link_to=C', ], BannerLinkTypes::PRODUCTS => [ 'title' => __('group_for_product'), 'href' => 'product_groups.manage?link_to=P', ], BannerLinkTypes::URL => [ 'title' => __('url'), 'href' => 'product_groups.manage?link_to=U', ], ]); list($groups, $search) = fn_get_groups($_REQUEST, Registry::get('settings.Appearance.admin_elements_per_page')); Tygh::$app['view']->assign('groups', $groups); Tygh::$app['view']->assign('search', $search); Tygh::$app['view']->assign('link_to', $search['link_to']); } elseif ($mode == 'delete') { if (!empty($_REQUEST['group_id'])) { fn_delete_affiliate_groups((array) $_REQUEST['group_id']); } else { fn_set_notification('E', __('error'), __('error_no_data')); } return [CONTROLLER_STATUS_REDIRECT, 'product_groups.manage']; } 